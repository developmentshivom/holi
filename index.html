<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Holi - Video Call</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        video { transform: scaleX(-1); width: 300px; height: 240px; border: 2px solid #ddd; margin: 5px; }
        .container { display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .buttons { margin: 10px; }
    </style>
</head>
<body>
    <h2>Virtual Holi - Video Call</h2>

    <div class="container">
        <video id="myVideo" autoplay playsinline muted></video>
        <video id="remoteVideo" autoplay playsinline></video>

        <div class="buttons" id="controls">
            <button onclick="startCall()">Start Call</button>
            <input type="text" id="peerIdInput" placeholder="Enter ID to connect">
            <button onclick="connectToPeer()">Connect</button>
            <br>
            <p>Your ID: <span id="myPeerId">Generating...</span></p>
            <input type="text" id="callLink" readonly>
            <button onclick="copyLink()">Copy Link</button>
        </div>
    </div>

    <script>
        let localStream;
        let peer = new Peer(); // Creates a new PeerJS connection
        let remotePeerId = new URLSearchParams(window.location.search).get("join"); // Get ID from URL if joining

        // Get camera and microphone access
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then((stream) => {
                localStream = stream;
                document.getElementById("myVideo").srcObject = stream;
                
                // Now that we have the stream, setup PeerJS event listeners
                setupPeerListeners();
            })
            .catch((error) => {
                console.error("Camera access denied!", error);
                alert("Please allow camera & microphone access in browser settings.");
            });

        function setupPeerListeners() {
            peer.on("open", (id) => {
                document.getElementById("myPeerId").textContent = id;
                document.getElementById("callLink").value = `${window.location.origin}?join=${id}`;
                
                if (remotePeerId) {
                    autoConnect(remotePeerId);
                }
            });

            peer.on("call", (call) => {
                console.log("Incoming call...");
                call.answer(localStream);
                call.on("stream", (remoteStream) => {
                    document.getElementById("remoteVideo").srcObject = remoteStream;
                });
            });
        }

        function startCall() {
            copyLink();
            alert("Link copied! Send it to Person B.");
        }

        function copyLink() {
            navigator.clipboard.writeText(document.getElementById("callLink").value);
        }

        function connectToPeer() {
            let remotePeerIdInput = document.getElementById("peerIdInput").value;
            if (remotePeerIdInput) {
                callPeer(remotePeerIdInput);
            }
        }

        function callPeer(peerId) {
            let call = peer.call(peerId, localStream);
            call.on("stream", (remoteStream) => {
                document.getElementById("remoteVideo").srcObject = remoteStream;
            });
        }

        function autoConnect(remoteId) {
            console.log("Auto-connecting to", remoteId);
            setTimeout(() => callPeer(remoteId), 2000); // Delay auto-connect to ensure peer is ready
        }
    </script>
</body>
</html>
