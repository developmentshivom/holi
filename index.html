<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Holi</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face-detection"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        video { width: 300px; height: 240px; border: 2px solid #ddd; margin: 5px; position: relative; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; }
        .color-btns { margin: 10px; }
    </style>
</head>
<body>
    <h2>Virtual Holi - Play with Colors!</h2>
    
    <div class="color-btns">
        <button onclick="setColor('red')">ðŸ”´ Red</button>
        <button onclick="setColor('blue')">ðŸ”µ Blue</button>
        <button onclick="setColor('yellow')">ðŸŸ¡ Yellow</button>
    </div>

    <div class="container" id="videoContainer"></div>

    <script>
        const socket = io();
        const peer = new Peer();
        let localStream;
        let peers = {};
        let selectedColor = "red";

        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then((stream) => {
                localStream = stream;
                addVideoStream(peer.id, stream, true);

                peer.on("open", (id) => {
                    socket.emit("join-room", "holi-room", id);
                });

                peer.on("call", (call) => {
                    call.answer(localStream);
                    call.on("stream", (userStream) => {
                        addVideoStream(call.peer, userStream, false);
                    });
                });

                socket.on("user-joined", (userId) => {
                    connectToNewUser(userId, stream);
                });

                socket.on("user-left", (userId) => {
                    if (peers[userId]) peers[userId].close();
                    document.getElementById(userId)?.remove();
                });
            })
            .catch((error) => console.error("Error accessing media devices:", error));

        function connectToNewUser(userId, stream) {
            const call = peer.call(userId, stream);
            call.on("stream", (userStream) => {
                addVideoStream(userId, userStream, false);
            });
            peers[userId] = call;
        }

        function addVideoStream(id, stream, isSelf) {
            const video = document.createElement("video");
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.id = id;
            video.addEventListener("click", () => applyColor(video));
            document.getElementById("videoContainer").appendChild(video);
        }

        function setColor(color) {
            selectedColor = color;
        }

        function applyColor(videoElement) {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            ctx.fillStyle = selectedColor;
            ctx.globalAlpha = 0.4;
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, 50, 0, Math.PI * 2);
            ctx.fill();

            videoElement.srcObject = null;
            videoElement.src = canvas.toDataURL();
        }
    </script>
</body>
</html>
