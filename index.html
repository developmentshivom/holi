<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Holi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face-detection"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        video { width: 300px; height: 240px; border: 2px solid #ddd; margin: 5px; position: relative; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; }
        .color-btns { margin: 10px; }
        canvas { position: absolute; top: 0; left: 0; width: 300px; height: 240px; pointer-events: none; }
    </style>
</head>
<body>
    <h2>Virtual Holi - Play with Colors!</h2>
    
    <div class="color-btns">
        <button onclick="setColor('red')">ðŸ”´ Red</button>
        <button onclick="setColor('blue')">ðŸ”µ Blue</button>
        <button onclick="setColor('yellow')">ðŸŸ¡ Yellow</button>
    </div>

    <div class="container" id="videoContainer"></div>

    <script>
        const socket = io("wss://opalescent-superb-sedum.glitch.me"); // Ensure correct WebSocket URL
        const peer = new Peer();
        let localStream;
        let peers = {};
        let selectedColor = "red";

        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then((stream) => {
                localStream = stream;

                peer.on("open", (id) => {
                    socket.emit("join-room", "holi-room", id);
                    addVideoStream(id, stream, true);
                });

                peer.on("call", (call) => {
                    call.answer(localStream);
                    call.on("stream", (userStream) => {
                        addVideoStream(call.peer, userStream, false);
                    });
                });

                socket.on("user-joined", (userId) => {
                    connectToNewUser(userId, stream);
                });

                socket.on("user-left", (userId) => {
                    if (peers[userId]) peers[userId].close();
                    document.getElementById(userId)?.remove();
                });
            });

        function connectToNewUser(userId, stream) {
            const call = peer.call(userId, stream);
            call.on("stream", (userStream) => {
                addVideoStream(userId, userStream, false);
            });
            peers[userId] = call;
        }

        function addVideoStream(id, stream, isSelf) {
            const container = document.createElement("div");
            container.style.position = "relative";
            container.id = id;

            const video = document.createElement("video");
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.width = 300;
            video.height = 240;
            video.addEventListener("click", () => applyColor(container));

            const canvas = document.createElement("canvas");
            canvas.width = 300;
            canvas.height = 240;
            canvas.style.position = "absolute";
            canvas.style.top = "0";
            canvas.style.left = "0";

            container.appendChild(video);
            container.appendChild(canvas);
            document.getElementById("videoContainer").appendChild(container);
        }

        function setColor(color) {
            selectedColor = color;
        }

        function applyColor(container) {
            const canvas = container.querySelector("canvas");
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = selectedColor;
            ctx.globalAlpha = 0.4;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Send color event to all peers
            socket.emit("apply-color", { userId: container.id, color: selectedColor });
        }

        socket.on("color-applied", ({ userId, color }) => {
            const container = document.getElementById(userId);
            if (container) {
                const canvas = container.querySelector("canvas");
                const ctx = canvas.getContext("2d");
                ctx.fillStyle = color;
                ctx.globalAlpha = 0.4;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        });
    </script>
</body>
</html>
