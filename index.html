<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Holi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face-detection"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        video { width: 300px; height: 240px; border: 2px solid #ddd; margin: 5px; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; }
        .color-btns { margin: 10px; }
    </style>
</head>
<body>
    <h2>Virtual Holi - Play with Colors!</h2>
    
    <div class="color-btns">
        <button onclick="setColor('red')">ðŸ”´ Red</button>
        <button onclick="setColor('blue')">ðŸ”µ Blue</button>
        <button onclick="setColor('yellow')">ðŸŸ¡ Yellow</button>
    </div>

    <div class="container" id="videoContainer"></div>

    <script>
        const socket = io.connect(window.location.origin);
        const peer = new Peer();
        let localStream;
        let peers = {};
        let selectedColor = "red";

        // Get camera and mic access
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then((stream) => {
                localStream = stream;
                addVideoStream(peer.id, stream, true);

                peer.on("open", (id) => {
                    socket.emit("join-room", "holi-room");
                });

                peer.on("call", (call) => {
                    call.answer(localStream);
                    call.on("stream", (userStream) => {
                        addVideoStream(call.peer, userStream, false);
                    });
                });

                socket.on("user-joined", (userId) => {
                    connectToNewUser(userId, stream);
                });

                socket.on("user-left", (userId) => {
                    if (peers[userId]) peers[userId].close();
                    document.getElementById(userId)?.remove();
                });
            });

        function connectToNewUser(userId, stream) {
            const call = peer.call(userId, stream);
            call.on("stream", (userStream) => {
                addVideoStream(userId, userStream, false);
            });
            peers[userId] = call;
        }

        function addVideoStream(id, stream, isSelf) {
            const video = document.createElement("video");
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.id = id;
            video.addEventListener("click", () => applyColor(video));
            document.getElementById("videoContainer").appendChild(video);
        }

        function setColor(color) {
            selectedColor = color;
        }

        function applyColor(videoElement) {
            const ctx = document.createElement("canvas").getContext("2d");
            ctx.canvas.width = videoElement.width;
            ctx.canvas.height = videoElement.height;
            ctx.drawImage(videoElement, 0, 0, ctx.canvas.width, ctx.canvas.height);

            ctx.fillStyle = selectedColor;
            ctx.globalAlpha = 0.4;
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            videoElement.srcObject = null;
            videoElement.src = ctx.canvas.toDataURL();
        }
    </script>
</body>
</html>
